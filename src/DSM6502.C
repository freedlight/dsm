// dsm6502.c - module to handle 6502 codes for DSM
// copyright (c) 1994, Freedlight Software

#include "dsm.h"

static char otyp6502[] = {
	11,26,00,00,00,23,23,00,11,22,12,00,00,31,31,00,	// 00 - 0F
	21,27,00,00,00,24,24,00,11,33,00,00,00,32,32,00,	// 10 - 1F
	31,26,00,00,23,23,23,00,11,22,12,00,31,31,31,00,	// 20 - 2F
	21,27,00,00,00,24,24,00,11,33,00,00,00,32,32,00,	// 30 - 3F
	11,26,00,00,00,23,23,00,11,22,12,00,31,31,31,00,	// 40 - 4F
	21,27,00,00,00,24,24,00,11,33,00,00,00,32,32,00,	// 50 - 5F
	11,26,00,00,00,23,23,00,11,22,12,00,34,31,31,00,	// 60 - 6F
	21,27,00,00,00,24,24,00,11,33,00,00,00,32,32,00,	// 70 - 7F
	00,26,00,00,23,23,23,00,11,00,11,00,31,31,31,00,	// 80 - 8F
	21,27,00,00,24,24,25,00,11,33,11,00,00,32,00,00,	// 90 - 9F
	22,26,22,00,23,23,23,00,11,22,11,00,31,31,31,00,	// A0 - AF
	21,27,00,00,24,24,25,00,11,33,11,00,32,32,33,00,	// B0 - BF
	22,26,00,00,23,23,23,00,11,22,11,00,31,31,31,00,	// C0 - CF
	21,27,00,00,00,24,24,00,11,33,00,00,00,32,32,00,	// D0 - DF
	22,26,00,00,23,23,23,00,11,22,11,00,31,31,31,00,	// E0 - EF
	21,27,00,00,00,24,24,00,11,33,00,00,00,32,32,00		// F0 - FF
};

static char otyp6501[] = {
	11,26,00,00,00,23,23,23,11,22,12,00,00,31,31,35,	// 00 - 0F
	21,27,00,00,00,24,24,23,11,33,00,00,00,32,32,35,	// 10 - 1F
	31,26,00,00,23,23,23,23,11,22,12,00,31,31,31,35,	// 20 - 2F
	21,27,00,00,00,24,24,23,11,33,00,00,00,32,32,35,	// 30 - 3F
	11,26,00,00,00,23,23,23,11,22,12,00,31,31,31,35,	// 40 - 4F
	21,27,00,00,00,24,24,23,11,33,00,00,00,32,32,35,	// 50 - 5F
	11,26,00,00,00,23,23,23,11,22,12,00,34,31,31,35,	// 60 - 6F
	21,27,00,00,00,24,24,23,11,33,00,00,00,32,32,35,	// 70 - 7F
	00,26,00,00,23,23,23,23,11,00,11,00,31,31,31,35,	// 80 - 8F
	21,27,00,00,24,24,25,23,11,33,11,00,00,32,00,35,	// 90 - 9F
	22,26,22,00,23,23,23,23,11,22,11,00,31,31,31,35,	// A0 - AF
	21,27,00,00,24,24,25,23,11,33,11,00,32,32,33,35,	// B0 - BF
	22,26,00,00,23,23,23,23,11,22,11,00,31,31,31,35,	// C0 - CF
	21,27,00,00,00,24,24,23,11,33,00,00,00,32,32,35,	// D0 - DF
	22,26,00,00,23,23,23,23,11,22,11,00,31,31,31,35,	// E0 - EF
	21,27,00,00,00,24,24,23,11,33,00,00,00,32,32,35		// F0 - FF
};

static char otyp65C00[] = {
	11,26,11,00,00,23,23,23,11,22,12,00,00,31,31,35,	// 00 - 0F
	21,27,00,00,00,24,24,23,11,33,00,00,00,32,32,35,	// 10 - 1F
	31,26,00,00,23,23,23,23,11,22,12,00,31,31,31,35,	// 20 - 2F
	21,27,00,00,00,24,24,23,11,33,00,00,00,32,32,35,	// 30 - 3F
	11,26,00,00,00,23,23,23,11,22,12,00,31,31,31,35,	// 40 - 4F
	21,27,00,00,00,24,24,23,11,33,11,00,00,32,32,35,	// 50 - 5F
	11,26,00,00,00,23,23,23,11,22,12,00,34,31,31,35,	// 60 - 6F
	21,27,00,00,00,24,24,23,11,33,11,00,00,32,32,35,	// 70 - 7F
	21,26,00,00,23,23,23,23,11,00,11,00,31,31,31,35,	// 80 - 8F
	21,27,00,00,24,24,25,23,11,33,11,00,00,32,00,35,	// 90 - 9F
	22,26,22,00,23,23,23,23,11,22,11,00,31,31,31,35,	// A0 - AF
	21,27,00,00,24,24,25,23,11,33,11,00,32,32,33,35,	// B0 - BF
	22,26,00,00,23,23,23,23,11,22,11,00,31,31,31,35,	// C0 - CF
	21,27,00,00,00,24,24,23,11,33,11,00,00,32,32,35,	// D0 - DF
	22,26,00,00,23,23,23,23,11,22,11,00,31,31,31,35,	// E0 - EF
	21,27,00,00,00,24,24,23,11,33,11,00,00,32,32,35		// F0 - FF
};

static char otyp65C02[] = {
	11,26,00,00,23,23,23,00,11,22,12,00,31,31,31,00,	// 00 - 0F
	21,27,28,00,23,24,24,00,11,33,12,00,31,32,32,00,	// 10 - 1F
	31,26,00,00,23,23,23,00,11,22,12,00,31,31,31,00,	// 20 - 2F
	21,27,28,00,24,24,24,00,11,33,12,00,32,32,32,00,	// 30 - 3F
	11,26,00,00,00,23,23,00,11,22,12,00,31,31,31,00,	// 40 - 4F
	21,27,28,00,00,24,24,00,11,33,11,00,00,32,32,00,	// 50 - 5F
	11,26,00,00,23,23,23,00,11,22,12,00,34,31,31,00,	// 60 - 6F
	21,27,28,00,24,24,24,00,11,33,11,00,26,32,32,00,	// 70 - 7F
	21,26,00,00,23,23,23,00,11,22,11,00,31,31,31,00,	// 80 - 8F
	21,27,28,00,24,24,25,00,11,33,11,00,31,32,32,00,	// 90 - 9F
	22,26,22,00,23,23,23,00,11,22,11,00,31,31,31,00,	// A0 - AF
	21,27,28,00,24,24,25,00,11,33,11,00,32,32,33,00,	// B0 - BF
	22,26,00,00,23,23,23,00,11,22,11,00,31,31,31,00,	// C0 - CF
	21,27,28,00,00,24,24,00,11,33,11,00,00,32,32,00,	// D0 - DF
	22,26,00,00,23,23,23,00,11,22,11,00,31,31,31,00,	// E0 - EF
	21,27,28,00,00,24,24,00,11,33,11,00,00,32,32,00		// F0 - FF
};

static char *onam6502[] = {
// 00 - 07
	"BRK","ORA","MUL",""   ,"TSB","ORA","ASL","RMB0",
// 08 - 0F
	"PHP","ORA","ASL",""   ,"TSB","ORA","ASL","BBR0",
// 10 - 17
	"BPL","ORA","ORA",""   ,"TRB","ORA","ASL","RMB1",
// 18 - 1F
	"CLC","ORA","INC",""   ,"TRB","ORA","ASL","BBR1",
// 20 - 27
	"JSR","AND",""   ,""   ,"BIT","AND","ROL","RMB2",
// 28 - 2F
	"PLP","AND","ROL",""   ,"BIT","AND","ROL","BBR2",
// 30 - 37
	"BMI","AND","AND",""   ,"BIT","AND","ROL","RMB3",
// 38 - 3F
	"SEC","AND","DEC",""   ,"BIT","AND","ROL","BBR3",
// 40 - 47
	"RTI","EOR",""   ,""   ,""   ,"EOR","LSR","RMB4",
// 48 - 4F
	"PHA","EOR","LSR",""   ,"JMP","EOR","LSR","BBR4",
// 50 - 57
	"BVC","EOR","EOR",""   ,""   ,"EOR","LSR","RMB5",
// 58 - 5F
	"CLI","EOR","PHY",""   ,""   ,"EOR","LSR","BBR5",
// 60 - 67
	"RTS","ADC",""   ,""   ,"STZ","ADC","ROR","RMB6",
// 68 - 6F
	"PLA","ADC","ROR",""   ,"JMP","ADC","ROR","BBR6",
// 70 - 77
	"BVS","ADC","ADC",""   ,"STZ","ADC","ROR","RMB7",
// 78 - 7F
	"SEI","ADC","PLY",""   ,"JMP","ADC","ROR","BBR7",
// 80 - 87
	"BRA","STA",""   ,""   ,"STY","STA","STX","SMB0",
// 88 - 8F
	"DEY","BIT","TXA",""   ,"STY","STA","STX","BBS0",
// 90 - 97
	"BCC","STA","STA",""   ,"STY","STA","STX","SMB1",
// 98 - 9F
	"TYA","STA","TXS",""   ,"STZ","STA","STZ","BBS1",
// A0 - A7
	"LDY","LDA","LDX",""   ,"LDY","LDA","LDX","SMB2",
// A8 - AF
	"TAY","LDA","TAX",""   ,"LDY","LDA","LDX","BBS2",
// B0 - B7
	"BCS","LDA","LDA",""   ,"LDY","LDA","LDX","SMB3",
// B8 - BF
	"CLV","LDA","TSX",""   ,"LDY","LDA","LDX","BBS3",
// C0 - C7
	"CPY","CMP",""   ,""   ,"CPY","CMP","DEC","SMB4",
// C8 - CF
	"INY","CMP","DEX",""   ,"CPY","CMP","DEC","BBS4",
// D0 - D7
	"BNE","CMP","CMP",""   ,""   ,"CMP","DEC","SMB5",
// D8 - DF
	"CLD","CMP","PHX",""   ,""   ,"CMP","DEC","BBS5",
// E0 - E7
	"CPX","SBC",""   ,""   ,"CPX","SBC","INC","SMB6",
// E8 - EF
	"INX","SBC","NOP",""   ,"CPX","SBC","INC","BBS6",
// F0 - F7
	"BEQ","SBC","SBC",""   ,""   ,"SBC","INC","SMB7",
// F8 - FF
	"SED","SBC","PLX",""   ,""   ,"SBC","INC","BBS7"
};

static void d6502init(void)
{
	opcsp = 10;
	argsp = 5;
	cmtsp = 12;
	init = TRUE;
}

static void d1_6502(short x)
{
	data1(x);
	putopc(onam6502[x]);
	switch (ofmt)
	{
		case 1:		// opr
			break;
		case 2:		// opr A
			putreg("A");
			break;
	}
	enddata1(x);
	if ((x == 0x40) || (x == 0x60))	// RTS & RTI
		putcr();
}

static void d2_6502(short x, short y)
{
	short adr;

	data2(x, y);
	putopc(onam6502[x]);
	switch (ofmt)
	{
		case 1:		// pc relative
			if (y > 0x80)
				adr = (pc + 2) - (0x100 - y);
			else
				adr = (pc + 2) + y;
			putaddr(adr);
			break;
		case 2:		// opr #$nn
			putimm(y);
			break;
		case 3:		// opr $nn
			putadr1(y);
			break;
		case 4:		// opr $nn,X
			putadr1(y);
			putcomma();
			putreg("X");
			break;
		case 5:		// opr $nn,Y
			putadr1(y);
			putcomma();
			putreg("Y");
			break;
		case 6:		// opr ($nn,X)
			putopn();
			putadr1(y);
			putcomma();
			putreg("X");
			putclo();
			break;
		case 7:		// opr ($nn),Y
			putopn();
			putadr1(y);
			putclo();
			putcomma();
			putreg("Y");
			break;
		case 8:		// opr ($nn)
			putopn();
			putadr1(y);
			putclo();
			break;
	}
	enddata2(x, y);
}

static void d3_6502(short x, short y, short z)
{
	short adr;

	data3(x, y, z);
	putopc(onam6502[x]);
	switch (ofmt)
	{
		case 1:		// opr $nnnn
			putadr2(z,y);
			break;
		case 2:		// opr $nnnn,X
			putadr2(z,y);
			putcomma();
			putreg("X");
			break;
		case 3:		// opr $nnnn,Y
			putadr2(z,y);
			putcomma();
			putreg("Y");
			break;
		case 4:		// opr ($nnnn)
			putopn();
			putadr2(z,y);
			putclo();
			break;
		case 5:		// bitopr $nn,rel
			putadr1(y);
			putcomma();
			if (z > 0x80)
				adr = (pc + 3) - (0x100 - z);
			else
				adr = (pc + 3) + z;
			putaddr(adr);
			break;
	}
	enddata3(x, y, z);
}

void dsm6502(short n)
{
	short x,y;
	char *typ;

	if (!init)
		d6502init();
#if DEBUG
	printf("op=%d pval=%d\n",n,otyp6502[n]);
#endif
	if (submach == X_6502)
		typ = otyp6502;
	else if (submach == X_6501 || submach == X_6511)
		typ = otyp6501;
	else if (submach == X_65C00)
		typ = otyp65C00;
	else if (submach == X_65C02 || submach == X_65C151)
		typ = otyp65C02;
	if (!typ[n])
	{
		inval(n);
		return;
	}
	omod = typ[n] / 10;
	ofmt = typ[n] % 10;
	if (omod == 1)
		d1_6502(n);
	else if (omod == 2)
	{
		x = getnxt();
		d2_6502(n,x);
	}
	else if (omod == 3)
	{
		x = getnxt();
		y = getnxt();
		d3_6502(n,x,y);
	}
}

